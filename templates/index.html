<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DMG Transliteration</title>
    <link rel="shortcut icon" href="/static/favicon.ico" type="image/x-icon">
    <!-- Import Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <style>
        html, body {
            height: 100%;
        }

        #grid-wrapper {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-rows: auto 1fr;
        }

        #grid-wrapper>*{
            min-width: 100%;
        }

        #side-bar>div {
            width: 250px;
            height: 100%;
            border-left: solid rgb(var(--bs-dark-rgb)) 2px;
        }

        main {
            width: 100%;
            height: 100%;
            display: grid;
            grid-template-columns: 1fr auto;
        }

        main>*{
            min-height: 100%;
        }

        #input-output {
            padding: 20px;
            height: 100%;
        }

        #input-output textarea {
            resize: none;
            min-height: 200px; 
            max-height: 40vh; 
            width: 100%;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div id="grid-wrapper">
        <nav class="navbar navbar-expand navbar-dark bg-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img src="/static/favicon.ico" width="30" height="30" class="d-inline-block align-text-top mr-1" alt="DMG icon">
                    DMG Transliteration
                </a>
                <ul class="navbar-nav justify-content-end">
                    <!-- <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li> -->
                    <li class="nav-item">
                        <button class="btn btn-dark" type="button" data-bs-toggle="collapse" data-bs-target="#side-bar" aria-controls="side-bar" aria-expanded="false">
                            Profile
                        </button>
                    </li>
                </ul>
            </div>
        </nav>
        <main>
            <div id="input-output" class="row">
                <div class="col-12 mb-1 h-50 col-lg-6 mb-lg-0 h-lg-50">
                    <textarea id="input-text"></textarea>
                </div>
                <div class="col-12 h-50 col-lg-6 h-lg-50">
                    <textarea id="output-text" disabled></textarea>
                </div>
            </div>
            <aside id="side-bar" class="collapse-horizontal">
                <div class="container-fluid">
                    <h2>Profile</h2>
                    <p>Profile settings will be here.</p>

                    {% for (name, value, type, title, description) in profile %}
                        {% if type == 'bool' %}
                            <div class="form-check form-switch mb-3">
                                <input id="{{name}}-profile-input" class="form-check-input" type="checkbox" role="switch" name="{{name}}" {% if value %} checked {% endif %}>
                                <label class="form-check-label" for="{{name}}-profile-input" title="{{description}}">
                                    {{title}}
                                </label>
                            </div>
                        {% endif %}
                    {%endfor%}
                </div>
            </aside>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        let timeoutId;
        const input = document.getElementById('input-text');
        const output = document.getElementById('output-text');
        const profile_inputs = document.querySelectorAll('#side-bar input[name]');

        const send_request = () => {
            const text = input.value;
            const profile = {};
            // TODO: This only works for booleans
            profile_inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    profile[input.name] = input.checked
                }
            });

            fetch('/transliterate', { method: 'POST', body: JSON.stringify({ text, profile }) })
            .then(response => response.ok 
                ? response.text() 
                : (()=>{throw new Error(response.status + ' ' + response.statusText)})()
            )
            .then(data => output.value = data)
            .catch(error => console.error('Error:', error));
            // TODO: real error handling
            console.log(text, profile);
        }

        input.addEventListener('input', () => {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(send_request, 1000); 
        });

        profile_inputs.forEach(input => input.addEventListener('change', send_request));
    </script>
</body>
</html>
